"use strict";const log=e=>host.diagnostics.debugLog(`${e}\n`),system=e=>host.namespace.Debugger.Utility.Control.ExecuteCommand(e),sizeof=e=>host.evaluateExpression(`sizeof(${e})`),u32=e=>host.memory.readMemoryValues(e,1,4)[0],u64=e=>host.memory.readMemoryValues(e,1,8)[0];function open(e){return host.namespace.Debugger.Utility.FileSystem.OpenFile(e)}function readlines(e){return host.namespace.Debugger.Utility.FileSystem.CreateTextReader(e).ReadLineContents()}function IsKd(){return!0===host.namespace.Debugger.Sessions.First().Attributes.Target.IsKernelTarget}const _POOL_TYPES={0:"NonPagedPool",1:"PagedPool",2:"NonPagedPoolMustSucceed",3:"DontUseThisType",4:"NonPagedPoolCacheAligned",5:"PagedPoolCacheAligned",6:"NonPagedPoolCacheAlignedMustS",7:"MaxPoolType",32:"NonPagedPoolSession",33:"PagedPoolSession",34:"NonPagedPoolMustSucceedSession",35:"DontUseThisTypeSession",36:"NonPagedPoolCacheAlignedSession",37:"PagedPoolCacheAlignedSession",38:"NonPagedPoolCacheAlignedMustSSession",512:"NonPagedPoolNx",516:"NonPagedPoolNxCacheAligned",544:"NonPagedPoolSessionNx"};function PoolTypeAsBitmaskString(e){let t=[];for(let o in _POOL_TYPES)o==e?t.push(_POOL_TYPES[o]):0!=o&&(e&o)==o&&t.push(_POOL_TYPES[o]);return 0==t.length?null:t.join("|")}function Hex2Ascii(e){for(var t=e.toString(16),o="",i=0;i<t.length&&"00"!==t.substr(i,2);i+=2)o+=String.fromCharCode(parseInt(t.substr(i,2),16));return o.split("").reverse().join("")}const POOLTAG_FILEPATH="\\\\ph0ny\\code\\windbg_js_scripts\\extra\\pooltag.txt";var g_PoolTag_Content=[];function GetTagInfo(e){for(let t of g_PoolTag_Content)if(t[0]===e)return t}function RefreshPooltagCache(){log(`caching content of ${POOLTAG_FILEPATH}, this might take a bit...`);let e=!1,t=open(POOLTAG_FILEPATH);try{for(let e of readlines(t)){if(void 0===e||0===e.length)continue;let t=e.trim();if(0===t.length)continue;if(t.toLowerCase().startsWith("rem")||t.startsWith("//"))continue;let o=t.split(" - ",3),i=null!=o[0]?o[0].trim():"",n=null!=o[1]?o[1].trim():"",s=null!=o[2]?o[2].trim():"";0!==i.length&&g_PoolTag_Content.push([i,n,s])}e=!0,log("done")}catch(e){log(`exception ${e}`)}finally{t.Close()}return e}class BigPool{constructor(e){this.__RawObject=e,this.__VirtualAddress=e.Va,this.__Tag=e.Key,this.__Size=e.NumberOfBytes,this.__Type=e.PoolType;let t=Hex2Ascii(this.__Tag),o=GetTagInfo(t);this.TagInfo=null!=o?{Name:t,BinaryName:o[1],Description:o[2]}:{Name:t,BinaryName:"",Description:""}}get VirtualAddress(){return this.__VirtualAddress.bitwiseShiftRight(1).bitwiseShiftLeft(1)}get Size(){return this.__Size}get Type(){let e=this.__Type,t=PoolTypeAsBitmaskString(e);return null===t?e.toString(16):t}get Tag(){let e=`'${this.TagInfo.Name}'`;return""===this.TagInfo.BinaryName&&""===this.TagInfo.Description||(e+=` (${this.TagInfo.BinaryName} - ${this.TagInfo.Description})`),e}get IsFreed(){return 0===this.__VirtualAddress.bitwiseAnd(1)}toString(){return`BigPool(VA=${this.VirtualAddress.toString(16)}, Tag=${this.Tag}, Size=${this.Size}, Type=${this.Type})`}}class BigPoolList{constructor(){this.PoolBigPageTablePointer=host.createPointerObject(host.getModuleSymbolAddress("nt","PoolBigPageTable"),"nt","_POOL_TRACKER_BIG_PAGES**"),this.PoolBigPageTable=this.PoolBigPageTablePointer.dereference(),this.PoolBigPageTableSize=u32(host.getModuleSymbolAddress("nt","PoolBigPageTableSize")),this.SizeOfPoolTracker=sizeof("_POOL_TRACKER_BIG_PAGES"),this.NumberOfEntries=Math.floor(this.PoolBigPageTableSize/this.SizeOfPoolTracker)}*[Symbol.iterator](){if(IsKd())for(let e=0;e<this.NumberOfEntries;e++)if(1==this.PoolBigPageTable[e].Va.compareTo(1)){let t=new BigPool(this.PoolBigPageTable[e]);yield t}}}function BigPoolIterator(){return void 0!==g_PoolTag_Content&&0!==g_PoolTag_Content.length||RefreshPooltagCache(),new BigPoolList}function initializeScript(){return log("[+] Adding function 'BigPool'"),[new host.functionAlias(BigPoolIterator,"BigPool"),new host.apiVersionSupport(1,3)]}